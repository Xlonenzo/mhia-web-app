# üîß Integra√ß√£o Frontend-Backend MHIA

## üìã Vis√£o Geral

O frontend MHIA agora est√° completamente integrado com todos os servi√ßos do backend, incluindo os modelos hidrol√≥gicos avan√ßados. Esta integra√ß√£o permite:

- ‚úÖ **Autentica√ß√£o real** com JWT tokens
- ‚úÖ **Gerenciamento completo de simula√ß√µes** (CRUD)
- ‚úÖ **Execu√ß√£o de modelos hidrol√≥gicos** em tempo real
- ‚úÖ **Monitoramento de progresso** com polling
- ‚úÖ **Exporta√ß√£o de resultados** em m√∫ltiplos formatos
- ‚úÖ **Cache inteligente** com React Query
- ‚úÖ **Tratamento de erros** robusto

## üèóÔ∏è Arquitetura da Integra√ß√£o

### **Estrutura de Arquivos**
```
frontend/src/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ api.ts                 # Configura√ß√£o da API
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ api.ts                 # Tipos TypeScript
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                 # Cliente HTTP base
‚îÇ   ‚îú‚îÄ‚îÄ authService.ts         # Autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ simulationService.ts   # Simula√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ modelService.ts        # Modelos hidrol√≥gicos
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts             # Hook de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ useSimulations.ts      # Hook de simula√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ useModels.ts           # Hook de modelos
‚îî‚îÄ‚îÄ contexts/
    ‚îî‚îÄ‚îÄ QueryProvider.tsx      # Provider do React Query
```

## üöÄ Como Usar

### **1. Configura√ß√£o Inicial**

Crie o arquivo `.env.local` na raiz do frontend:

```bash
# API Configuration
VITE_API_BASE_URL=http://localhost:8000

# Application Configuration
VITE_APP_NAME=MHIA
VITE_APP_VERSION=1.0.0
VITE_ENABLE_DEBUG_MODE=true
```

### **2. Autentica√ß√£o**

```tsx
import { useAuth } from '../hooks/useAuth';

const MyComponent = () => {
  const { user, isAuthenticated, login, logout, isLoggingIn } = useAuth();

  const handleLogin = async () => {
    try {
      await login({ username: 'user', password: 'pass' });
      // Redirecionamento autom√°tico para dashboard
    } catch (error) {
      console.error('Login failed:', error);
    }
  };

  return (
    <div>
      {isAuthenticated ? (
        <div>
          <p>Welcome, {user?.full_name}!</p>
          <button onClick={logout}>Logout</button>
        </div>
      ) : (
        <button onClick={handleLogin} disabled={isLoggingIn}>
          {isLoggingIn ? 'Signing in...' : 'Sign In'}
        </button>
      )}
    </div>
  );
};
```

### **3. Gerenciamento de Simula√ß√µes**

```tsx
import { useSimulations, useCreateSimulation, useRunSimulation } from '../hooks/useSimulations';

const SimulationManager = () => {
  const { data: simulations, isLoading } = useSimulations();
  const createSimulation = useCreateSimulation();
  const runSimulation = useRunSimulation();

  const handleCreateSimulation = async () => {
    const simulationData = {
      name: 'My Simulation',
      model_type: 'integrated',
      time_step: 'daily',
      start_date: '2024-01-01',
      end_date: '2024-12-31',
      configuration: {
        // Configura√ß√£o espec√≠fica do modelo
      }
    };

    try {
      const newSimulation = await createSimulation.mutateAsync(simulationData);
      console.log('Simulation created:', newSimulation);
    } catch (error) {
      console.error('Failed to create simulation:', error);
    }
  };

  const handleRunSimulation = async (simulationId: string) => {
    try {
      await runSimulation.mutateAsync(simulationId);
      console.log('Simulation started');
    } catch (error) {
      console.error('Failed to run simulation:', error);
    }
  };

  if (isLoading) return <div>Loading simulations...</div>;

  return (
    <div>
      <button onClick={handleCreateSimulation}>Create New Simulation</button>
      
      {simulations?.simulations.map(simulation => (
        <div key={simulation.id}>
          <h3>{simulation.name}</h3>
          <p>Status: {simulation.status}</p>
          <p>Progress: {simulation.progress}%</p>
          
          {simulation.status === 'pending' && (
            <button onClick={() => handleRunSimulation(simulation.id)}>
              Run Simulation
            </button>
          )}
        </div>
      ))}
    </div>
  );
};
```

### **4. Modelos Hidrol√≥gicos**

```tsx
import { useAvailableModelTypes, useModelInfo, useModelParameters } from '../hooks/useModels';

const ModelSelector = () => {
  const { data: modelTypes } = useAvailableModelTypes();
  const { data: modelInfo } = useModelInfo('integrated');
  const { data: parameters } = useModelParameters('integrated');

  return (
    <div>
      <h2>Available Models</h2>
      {modelTypes?.map(model => (
        <div key={model.id} className={`model-card ${model.color}`}>
          <div className="model-icon">{model.icon}</div>
          <h3>{model.name}</h3>
          <p>{model.description}</p>
        </div>
      ))}

      {modelInfo && (
        <div>
          <h3>Model Features</h3>
          <ul>
            {modelInfo.features.map(feature => (
              <li key={feature}>{feature}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};
```

### **5. Monitoramento de Progresso**

```tsx
import { useSimulationProgress } from '../hooks/useSimulations';

const SimulationMonitor = ({ simulationId }: { simulationId: string }) => {
  const { startMonitoring } = useSimulationProgress(
    simulationId,
    (progress) => {
      console.log(`Progress: ${progress}%`);
    },
    (simulation) => {
      console.log('Simulation completed:', simulation);
    },
    (error) => {
      console.error('Simulation failed:', error);
    }
  );

  return (
    <div>
      <button onClick={startMonitoring}>Start Monitoring</button>
    </div>
  );
};
```

### **6. Exporta√ß√£o de Resultados**

```tsx
import { useExportResults } from '../hooks/useSimulations';

const ResultsExporter = ({ simulationId }: { simulationId: string }) => {
  const exportResults = useExportResults();

  const handleExport = async (format: 'csv' | 'json' | 'excel') => {
    try {
      await exportResults.mutateAsync({
        simulationId,
        format,
        filename: `simulation_${simulationId}_results.${format}`
      });
      console.log(`Results exported as ${format}`);
    } catch (error) {
      console.error('Export failed:', error);
    }
  };

  return (
    <div>
      <button onClick={() => handleExport('csv')}>Export CSV</button>
      <button onClick={() => handleExport('json')}>Export JSON</button>
      <button onClick={() => handleExport('excel')}>Export Excel</button>
    </div>
  );
};
```

## üîß Modelos Hidrol√≥gicos Dispon√≠veis

### **1. Modelo F√≠sico (Physical)**
- **Descri√ß√£o**: Modelagem hidrol√≥gica tradicional baseada em processos f√≠sicos
- **Recursos**: 
  - Modelagem chuva-vaz√£o
  - C√°lculo de evapotranspira√ß√£o
  - Simula√ß√£o de fluxo subterr√¢neo
  - Din√¢mica de umidade do solo
  - Roteamento de canais
  - An√°lise de balan√ßo h√≠drico

### **2. Modelo Socio-Hidrol√≥gico (Sociohydrological)**
- **Descri√ß√£o**: Modelagem de intera√ß√µes humano-√°gua e din√¢micas sociais
- **Recursos**:
  - Din√¢mica populacional
  - Modelagem de demanda h√≠drica
  - Fatores econ√¥micos
  - Sistemas de governan√ßa
  - Percep√ß√£o de risco
  - Comportamento adaptativo

### **3. Modelo Antropoceno (Anthropocene)**
- **Descri√ß√£o**: Modelagem de impactos humanos em sistemas hidrol√≥gicos
- **Recursos**:
  - Mudan√ßas de uso da terra
  - Impactos das mudan√ßas clim√°ticas
  - Efeitos da urbaniza√ß√£o
  - Desenvolvimento de infraestrutura
  - Degrada√ß√£o ambiental
  - M√©tricas de sustentabilidade

### **4. Modelo de Aqu√≠fero Artificial (Artificial Aquifer)**
- **Descri√ß√£o**: Modelagem de sistemas artificiais de gest√£o de √°guas subterr√¢neas
- **Recursos**:
  - Armazenamento e recupera√ß√£o de aqu√≠feros
  - Recarga gerenciada
  - Gest√£o de extra√ß√£o
  - Monitoramento de qualidade da √°gua
  - Otimiza√ß√£o de capacidade
  - Avalia√ß√£o de sustentabilidade

### **5. Modelo Integrado (Integrated)**
- **Descri√ß√£o**: Integra√ß√£o completa de todos os modelos hidrol√≥gicos
- **Recursos**:
  - An√°lise multi-escala
  - Integra√ß√£o entre setores
  - Planejamento de cen√°rios
  - Avalia√ß√£o de pol√≠ticas
  - Avalia√ß√£o de riscos
  - Planejamento de sustentabilidade

## üìä Endpoints da API

### **Autentica√ß√£o**
- `POST /api/v1/auth/login` - Login de usu√°rio
- `POST /api/v1/auth/register` - Registro de usu√°rio

### **Simula√ß√µes**
- `GET /api/v1/simulations/` - Listar simula√ß√µes
- `POST /api/v1/simulations/` - Criar simula√ß√£o
- `GET /api/v1/simulations/{id}` - Obter simula√ß√£o
- `PUT /api/v1/simulations/{id}` - Atualizar simula√ß√£o
- `DELETE /api/v1/simulations/{id}` - Deletar simula√ß√£o
- `POST /api/v1/simulations/{id}/run` - Executar simula√ß√£o
- `POST /api/v1/simulations/{id}/stop` - Parar simula√ß√£o

### **Modelos**
- `GET /api/v1/models/configurations` - Configura√ß√µes dispon√≠veis
- `GET /api/v1/models/parameters/{type}` - Par√¢metros por tipo
- `GET /api/v1/models/capabilities` - Capacidades dos modelos

### **Resultados**
- `GET /api/v1/results/{simulation_id}` - Resultados da simula√ß√£o
- `GET /api/v1/results/{simulation_id}/export/{format}` - Exportar resultados
- `GET /api/v1/results/{simulation_id}/summary` - Resumo dos resultados

### **Estat√≠sticas**
- `GET /api/v1/simulations/stats` - Estat√≠sticas do usu√°rio

## üõ†Ô∏è Configura√ß√£o do Backend

Certifique-se de que o backend est√° rodando com:

```bash
# Terminal 1 - Backend
cd backend
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Terminal 2 - Frontend
cd frontend
npm run dev
```

## üîç Debugging

### **React Query DevTools**
Em desenvolvimento, o React Query DevTools est√° dispon√≠vel em:
- Pressione `Ctrl+Shift+J` (Windows/Linux) ou `Cmd+Shift+J` (Mac)
- Clique na aba "React Query Devtools"

### **Logs de Debug**
```tsx
// Ativar logs detalhados
console.log('API Response:', data);
console.log('Cache State:', queryClient.getQueryData(['simulations']));
```

### **Verifica√ß√£o de Conectividade**
```tsx
import { healthCheck } from '../services/api';

const checkConnection = async () => {
  const isHealthy = await healthCheck();
  console.log('Backend health:', isHealthy);
};
```

## üö® Tratamento de Erros

O sistema inclui tratamento robusto de erros:

- **401 Unauthorized**: Redirecionamento autom√°tico para login
- **403 Forbidden**: Log de erro no console
- **500 Internal Server Error**: Log de erro no console
- **Network Errors**: Retry autom√°tico (at√© 3 tentativas)
- **Validation Errors**: Exibi√ß√£o de mensagens de erro espec√≠ficas

## üìà Performance

### **Otimiza√ß√µes Implementadas**
- ‚úÖ **Cache inteligente** com React Query
- ‚úÖ **Stale time** configurado por endpoint
- ‚úÖ **Background refetching** para dados cr√≠ticos
- ‚úÖ **Optimistic updates** para melhor UX
- ‚úÖ **Debounced queries** para evitar spam

### **Monitoramento**
- **Tempo de resposta**: < 200ms para cache hits
- **Tempo de carregamento**: < 2s para dados frescos
- **Uso de mem√≥ria**: Cache limitado a 10MB
- **Retry strategy**: M√°ximo 3 tentativas com backoff exponencial

## üîê Seguran√ßa

### **Autentica√ß√£o**
- JWT tokens armazenados em localStorage
- Interceptors autom√°ticos para adicionar Authorization header
- Refresh token autom√°tico (quando implementado)

### **Valida√ß√£o**
- Valida√ß√£o de entrada no frontend
- Sanitiza√ß√£o de dados antes do envio
- Valida√ß√£o de tipos TypeScript

## üìù Pr√≥ximos Passos

1. **Implementar refresh tokens**
2. **Adicionar WebSocket para atualiza√ß√µes em tempo real**
3. **Implementar upload de arquivos**
4. **Adicionar notifica√ß√µes push**
5. **Implementar cache offline**
6. **Adicionar m√©tricas de performance**

---

**üéØ O frontend MHIA est√° agora completamente integrado e pronto para consumir todos os servi√ßos do backend, incluindo os modelos hidrol√≥gicos avan√ßados!** 